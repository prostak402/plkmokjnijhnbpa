<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FilmClips — Desktop • Aurora Glass 2025</title>
  <style>
    /*
      Design direction: AURORA GLASS (2025)
      — тёмный фон с живыми «аурамями», стеклянные панели, мягкие тени,
        крупная типографика, большие воздушные CTA, микровзаимодействия.
    */
    :root{
      --bg:#06060a;--surface:rgba(255,255,255,.04);--rail:rgba(255,255,255,.03);--elev:rgba(255,255,255,.06);
      --text:#f7f8fb;--muted:#a9b0bf;--line:rgba(255,255,255,.12);
      --primary:#7c5cff;--primary-2:#17d9ff;--accent:#ff4e88;--success:#22c55e;--danger:#ef4444;
      --r10:10px;--r12:12px;--r16:16px;--r20:20px;--r24:24px;--pill:9999px;
      --shadow-1:0 10px 24px rgba(0,0,0,.35);--shadow-2:0 18px 46px rgba(0,0,0,.5);
      --colW:720px; /* ширина центральной колонки */
      --blur:14px;--fast:.15s;--ease:cubic-bezier(.2,.6,.2,1);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
    a{color:inherit;text-decoration:none}
    button{font:inherit}

    /* ===== ICON SYSTEM ===== */
    .ic{width:22px;height:22px;display:block;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
    .btn-ghost .ic{width:18px;height:18px}

    /* ===== LAYOUT ===== */
    .layout{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    .sidebar{backdrop-filter:blur(var(--blur));background:var(--rail);border-right:1px solid var(--line);position:sticky;top:0;height:100vh;padding:16px 14px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;margin:4px 6px 18px;color:#eaf2ff}
    .diamond{width:18px;height:18px;border-radius:6px;background:conic-gradient(from 10deg at 60% 40%,#8af 0 25%,#4bf 25% 55%,#a8f 55% 80%,#6df 80% 100%);box-shadow:0 0 18px rgba(90,160,255,.8)}

    .snav{display:flex;flex-direction:column;gap:6px}
    .sitem{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:14px;color:var(--muted);cursor:pointer;backdrop-filter:blur(calc(var(--blur)/1.6));border:1px solid transparent}
    .sitem:hover{background:var(--surface);color:#e6ebff;border-color:var(--line)}
    .sitem.active{background:linear-gradient(180deg,rgba(124,92,255,.22),rgba(23,217,255,.16));color:#fff;border-color:transparent;box-shadow:inset 0 1px 0 rgba(255,255,255,.08)}
    .sitem span{font-weight:700}
    .sfooter{position:absolute;left:14px;right:14px;bottom:12px;color:var(--muted);font-size:12px;display:flex;gap:12px;flex-wrap:wrap}

    /* Stage: центральная колонка с клипами */
    .stage-wrap{display:grid;grid-template-columns:minmax(0,1fr) var(--colW) minmax(0,1fr);} /* центрируем колонку */
    .stage{grid-column:2/span 1;position:relative;height:100vh;display:flex;}
    .video-col{position:relative;margin:0 auto;height:100vh;width:var(--colW);background:#000;border-left:1px solid var(--line);border-right:1px solid var(--line);overflow:hidden}

    /* АУРОРЫ/ЭФФЕКТЫ */
    .vfx{position:absolute;inset:-10%;pointer-events:none;z-index:3;mix-blend-mode:screen;opacity:.4;filter:blur(26px)}
    .vfx::before,.vfx::after{content:"";position:absolute;inset:0;background:radial-gradient(40% 40% at 15% 15%,#7c5cff 0,#0000 60%),radial-gradient(45% 45% at 85% 15%,#17d9ff 0,#0000 60%),radial-gradient(50% 50% at 50% 115%,#ff4e88 0,#0000 55%)}
    .vfx{animation:aurora 14s linear infinite alternate}
    @keyframes aurora{0%{transform:translate3d(-2%,0,0) scale(1)}100%{transform:translate3d(2%,2%,0) scale(1.05)}}

    .titlebar{position:absolute;top:0;left:0;right:0;height:60px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,.75),rgba(0,0,0,0));z-index:10}
    .titlebar .btn-back{position:absolute;left:14px;top:12px}
    .btn-ghost{height:38px;padding:0 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);display:inline-flex;align-items:center;gap:8px;cursor:pointer}

    /* Фид */
    #feedView{position:absolute;inset:0;overflow-y:auto;scroll-snap-type:y mandatory}
    #feedView::-webkit-scrollbar{width:10px}
    #feedView::-webkit-scrollbar-thumb{background:linear-gradient(180deg,rgba(124,92,255,.6),rgba(23,217,255,.6));border-radius:999px}
    #feedView{scrollbar-color:rgba(124,92,255,.6) transparent}
    .clip{position:relative;height:100%;scroll-snap-align:start}
    .clip video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:2}
    .grad-top{position:absolute;inset:0 0 auto 0;height:46%;background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,0));z-index:4}
    .grad-bottom{position:absolute;inset:auto 0 0 0;height:48%;background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.92));z-index:4}

    /* Overlay Play (tap to pause/play) */
    .play-overlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:78px;height:78px;border-radius:999px;background:rgba(255,255,255,.16);backdrop-filter:blur(6px);display:grid;place-items:center;border:1px solid rgba(255,255,255,.28);z-index:6;transition:transform var(--fast) var(--ease)}
    .play-overlay:active{transform:translate(-50%,-50%) scale(.96)}

    /* Info + actions */
    .info{position:absolute;left:18px;right:160px;bottom:120px;z-index:6}
    .title{font-weight:900;font-size:24px;letter-spacing:.2px;text-shadow:0 2px 12px rgba(0,0,0,.65)}
    .meta{color:var(--muted);font-size:13px;margin-top:6px}
    .logline{margin-top:12px;opacity:.98}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tag{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--line);backdrop-filter:blur(8px)}

    .actions-rail{position:absolute;right:14px;bottom:128px;display:flex;flex-direction:column;align-items:center;gap:12px;z-index:6}
    .action{width:54px;height:54px;border-radius:18px;background:rgba(20,20,30,.55);backdrop-filter:blur(8px);border:1px solid var(--line);display:grid;place-items:center;cursor:pointer;transition:transform var(--fast) var(--ease), box-shadow var(--fast) var(--ease)}
    .action:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(124,92,255,.22)}
    .action .count{font-size:12px;color:var(--muted);margin-top:6px}

    /* CTA: большая кнопка Смотреть */
    .cta{position:absolute;left:0;right:0;bottom:18px;display:flex;justify-content:center;z-index:7;pointer-events:none}
    .cta-watch{pointer-events:auto;display:flex;align-items:center;gap:14px;min-width:70%;max-width:88%;height:64px;border:none;border-radius:999px;padding:0 20px;background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff;box-shadow:0 12px 44px rgba(124,92,255,.35);cursor:pointer;position:relative;overflow:hidden}
    .cta-watch:active{transform:scale(.985)}
    .cta-watch::after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,#fff6 0 10%,#fff0 40% 60%,#fff6 90% 100%);transform:translateX(-120%);filter:blur(6px)}
    .cta-watch:hover::after{animation:sheen 1.1s var(--ease)}
    @keyframes sheen{to{transform:translateX(120%)}}
    .cta-label{display:flex;flex-direction:column;line-height:1.1;text-align:left}
    .cta-title{font-weight:900;letter-spacing:.2px}
    .cta-sub{font-size:12px;opacity:.92}

    /* Прочие экраны */
    .panel{grid-column:2/span 1;min-height:100vh;padding:16px 16px 40px;background:rgba(255,255,255,.02);backdrop-filter:blur(calc(var(--blur)/1.4));display:none;border-left:1px solid var(--line);border-right:1px solid var(--line)}
    .panel.active{display:block}

    /* Onboarding */
    .onb{position:fixed;inset:0;background:radial-gradient(60% 60% at 50% 20%, rgba(124,92,255,.22), rgba(11,11,15,.92)), rgba(11,11,15,.96);z-index:50;display:none}
    .onb.active{display:grid;place-items:center}
    .onb-card{width:min(720px,92vw);background:rgba(26,26,36,.9);border:1px solid var(--line);border-radius:var(--r24);padding:22px 20px 16px;box-shadow:var(--shadow-2);backdrop-filter:blur(var(--blur))}
    .chips{display:flex;flex-wrap:wrap;gap:10px;margin:16px 0 10px}
    .chip{padding:10px 14px;border-radius:var(--pill);border:1px solid var(--line);background:rgba(255,255,255,.05);cursor:pointer}
    .chip.active{background:linear-gradient(135deg,rgba(124,92,255,.28),rgba(23,217,255,.18));border-color:transparent}
    .btn{height:44px;padding:0 16px;border-radius:var(--r12);border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-2));border-color:transparent;font-weight:800}

    /* Comments sheet */
    .sheet{position:fixed;left:0;right:0;bottom:-100%;height:min(70svh,640px);background:rgba(26,26,36,.95);border-top-left-radius:24px;border-top-right-radius:24px;box-shadow:0 -10px 30px rgba(0,0,0,.5);transition:bottom .28s var(--ease);z-index:60;display:flex;flex-direction:column;border-top:1px solid var(--line);backdrop-filter:blur(var(--blur))}
    .sheet.active{bottom:0}
    .sheet .grab{width:46px;height:5px;border-radius:var(--pill);background:#2b2b3a;margin:8px auto}
    .sheet-header{display:flex;align-items:center;justify-content:space-between;padding:0 12px 6px}
    .sheet-title{font-weight:800}
    .sheet-list{flex:1;overflow:auto;padding:8px 12px 10px}
    .cmt{display:flex;gap:10px;padding:12px 6px;border-bottom:1px dashed rgba(255,255,255,.06)}
    .ava{width:34px;height:34px;border-radius:50%;background:#2b2b39;display:grid;place-items:center;font-size:12px;color:#c8cbe0}
    .cbody{flex:1}
    .ctime{color:var(--muted);font-size:12px}
    .ctime .jump{padding:2px 8px;border-radius:var(--pill);border:1px solid var(--line);cursor:pointer;margin-left:6px}
    .cform{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line)}
    .cform input{flex:1;height:44px;border-radius:var(--r16);border:1px solid var(--line);background:#0e0e14;color:var(--text);padding:0 12px}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:30px;background:rgba(26,26,36,.95);border:1px solid var(--line);padding:10px 14px;border-radius:var(--r12);opacity:0;pointer-events:none;transition:opacity .25s;z-index:80}
    .toast.show{opacity:1}

    @media(max-width:1100px){
      .layout{grid-template-columns:72px 1fr}
      .sitem span{display:none}
      .brand{justify-content:center}
    }
  </style>
</head>
<body>
  <!-- SVG SPRITE -->
  <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden">
    <symbol id="i-home" viewBox="0 0 24 24"><path d="M3 11l9-8 9 8v9a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-4H9v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-9Z"/></symbol>
    <symbol id="i-clips" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="3"/><path d="M10 8v6l5-3-5-3Z" fill="currentColor" stroke="none"/></symbol>
    <symbol id="i-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M20 20l-3.5-3.5"/></symbol>
    <symbol id="i-ellipsis" viewBox="0 0 24 24"><circle cx="6" cy="12" r="1.7"/><circle cx="12" cy="12" r="1.7"/><circle cx="18" cy="12" r="1.7"/></symbol>
    <symbol id="i-user" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 21a8 8 0 0 1 16 0"/></symbol>
    <symbol id="i-bookmark" viewBox="0 0 24 24"><path d="M6 3h12v18l-6-4-6 4V3Z"/></symbol>
    <symbol id="i-heart" viewBox="0 0 24 24"><path d="M12 21s-7-4.35-7-10a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 5.65-7 10-7 10Z"/></symbol>
    <symbol id="i-chat" viewBox="0 0 24 24"><path d="M21 12a8 8 0 1 1-3.1-6.36L21 6l-.26 3.13A8 8 0 0 1 21 12Z"/></symbol>
    <symbol id="i-share" viewBox="0 0 24 24"><path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"/><path d="M12 16V3m0 0 4 4M12 3 8 7"/></symbol>
    <symbol id="i-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7-11-7Z" fill="currentColor" stroke="none"/></symbol>
    <symbol id="i-x" viewBox="0 0 24 24"><path d="M6 6l12 12M18 6 6 18"/></symbol>
  </svg>

  <div class="layout" id="app">
    <aside class="sidebar">
      <div class="brand"><span class="diamond"></span><span>Ton.Place</span></div>
      <nav class="snav" id="sidebarNav">
        <div class="sitem active" data-tab="feed"><svg class="ic"><use href="#i-clips"/></svg><span>Клипы</span></div>
        <div class="sitem" data-tab="genres"><svg class="ic"><use href="#i-ellipsis"/></svg><span>Жанры</span></div>
        <div class="sitem" data-tab="bookmarks"><svg class="ic"><use href="#i-bookmark"/></svg><span>Закладки</span></div>
        <div class="sitem" data-tab="catalog" data-open="https://example.com/films"><svg class="ic"><use href="#i-search"/></svg><span>Каталог фильмов</span></div>
        <div class="sitem" data-tab="profile"><svg class="ic"><use href="#i-user"/></svg><span>Профиль</span></div>
      </nav>
      <div class="sfooter"><a href="#">Помощь</a><a href="#">Соглашение</a><a href="#">Политика</a></div>
    </aside>

    <div class="stage-wrap">
      <!-- CENTRAL COLUMN -->
      <section class="stage">
        <div class="video-col">
          <div class="vfx" aria-hidden="true"></div>
          <div class="titlebar">
            <button class="btn-ghost btn-back" id="btnBack"><svg class="ic"><use href="#i-home"/></svg><span style="display:none">Назад</span></button>
            <div style="font-weight:900;letter-spacing:.3px">Клипы</div>
            <button class="btn-ghost" id="btnSettings" style="position:absolute;right:14px;top:12px"><svg class="ic"><use href="#i-ellipsis"/></svg></button>
          </div>

          <main id="feedView" aria-label="Лента клипов"></main>

          <!-- Big bottom CTA -->
          <div class="cta">
            <button class="cta-watch" id="ctaWatch" title="Откроется страница фильма на вашем сайте">
              <svg class="ic"><use href="#i-play"/></svg>
              <div class="cta-label">
                <div class="cta-title" id="ctaTitle">Смотреть фильм</div>
                <div class="cta-sub">Откроется на вашем киносайте</div>
              </div>
            </button>
          </div>
        </div>
      </section>

      <!-- BOOKMARKS / PROFILE PANELS -->
      <section id="bookmarksView" class="panel" aria-label="Закладки">
        <h2 style="margin:8px 0 12px">Закладки</h2>
        <div class="grid" id="bookGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px"></div>
      </section>

      <section id="profileView" class="panel" aria-label="Профиль">
        <h2 style="margin:8px 0 6px">Профиль</h2>
        <p class="muted">Гость. Включите вход, чтобы синхронизировать закладки между устройствами.</p>
        <div style="height:12px"></div>
        <h3 style="margin:16px 0 6px">Настройки воспроизведения</h3>
        <label style="display:flex; align-items:center; gap:8px; margin:8px 0"><input id="autoplayToggle" type="checkbox" checked /> Автовоспроизведение</label>
        <label style="display:flex; align-items:center; gap:8px; margin:8px 0"><input id="muteDefaultToggle" type="checkbox" checked /> Начинать без звука</label>
        <div style="height:16px"></div>
        <h3 style="margin:16px 0 6px">Жанры</h3>
        <div class="muted" id="currentGenres">—</div>
        <div style="height:8px"></div>
        <button class="btn" id="changeGenresBtn">Изменить жанры</button>
      </section>
    </div>
  </div>

  <!-- Onboarding genres -->
  <div class="onb" id="onb">
    <div class="onb-card">
      <h2>Выберите жанры</h2>
      <div class="muted">Выберите 3+ жанра — рекомендации станут точнее</div>
      <div class="chips" id="genreChips"></div>
      <div style="display:flex;justify-content:space-between;gap:10px;margin-top:10px">
        <button class="btn" id="skipOnb">Пропустить</button>
        <button class="btn primary" id="confirmOnb">Продолжить</button>
      </div>
    </div>
  </div>

  <!-- Comments bottom sheet -->
  <div class="sheet" id="commentsSheet" aria-modal="true" aria-hidden="true" role="dialog">
    <div class="grab"></div>
    <div class="sheet-header">
      <div class="sheet-title">Комментарии</div>
      <button class="btn-ghost" id="closeComments" aria-label="Закрыть"><svg class="ic"><use href="#i-x"/></svg></button>
    </div>
    <div class="sheet-list" id="commentsList"></div>
    <form class="cform" id="commentForm">
      <input type="text" id="commentInput" maxlength="300" placeholder="Оставьте комментарий" />
      <button class="btn primary" type="submit">Отправить</button>
    </form>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  // -------- Mock data ---------
  const CLIPS = [
    { id:'c1', filmTitle:'Неоновые тени', year:2021, genres:['sci-fi','thriller'], logline:'Детектив в кибер-городе расследует память, а не преступления.',
      src:'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4', poster:'', tags:['#сайфай','#нуар'], filmSlug:'neon-shadows',
      watchUrl:'https://example.com/film/neon-shadows?utm_source=app&utm_medium=watch_button&utm_campaign=clips' },
    { id:'c2', filmTitle:'Винт времени', year:2019, genres:['drama','mystery'], logline:'Физик застрял в петле одного вечера и одного выбора.',
      src:'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4', poster:'', tags:['#петля','#интрига'], filmSlug:'time-screw',
      watchUrl:'https://example.com/film/time-screw?utm_source=app&utm_medium=watch_button&utm_campaign=clips' },
    { id:'c3', filmTitle:'Город дождя', year:2023, genres:['action','crime'], logline:'Водитель-курьер ночью перевозит то, чего лучше не знать.',
      src:'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4', poster:'', tags:['#ночь','#погоня'], filmSlug:'rain-city',
      watchUrl:'https://example.com/film/rain-city?utm_source=app&utm_medium=watch_button&utm_campaign=clips' }
  ];

  const GENRES = [
    {id:'action', name:'Боевик'}, {id:'sci-fi', name:'Фантастика'}, {id:'drama', name:'Драма'}, {id:'comedy', name:'Комедия'},
    {id:'thriller', name:'Триллер'}, {id:'mystery', name:'Мистика'}, {id:'crime', name:'Криминал'}, {id:'romance', name:'Романтика'},
    {id:'horror', name:'Хоррор'}, {id:'adventure', name:'Приключения'}, {id:'animation', name:'Анимация'}
  ];

  const CATALOG_URL = 'https://example.com/films'; // TODO: подставить твой домен

  // -------- State ---------
  const state = {
    currentClipId:null,
    likes: JSON.parse(localStorage.getItem('likes')||'{}'),
    bookmarks: JSON.parse(localStorage.getItem('bookmarks')||'{}'),
    comments: JSON.parse(localStorage.getItem('comments')||'{}'),
    genres: JSON.parse(localStorage.getItem('genres')||'[]'),
    settings: JSON.parse(localStorage.getItem('settings')||'{"autoplay":true,"muteDefault":true}')
  };

  const els = {
    feedView: document.getElementById('feedView'),
    bookView: document.getElementById('bookmarksView'),
    profileView: document.getElementById('profileView'),
    sidebarNav: document.getElementById('sidebarNav'),
    onb: document.getElementById('onb'), genreChips: document.getElementById('genreChips'),
    skipOnb: document.getElementById('skipOnb'), confirmOnb: document.getElementById('confirmOnb'),
    toast: document.getElementById('toast'),
    commentsSheet: document.getElementById('commentsSheet'), commentsList: document.getElementById('commentsList'),
    commentForm: document.getElementById('commentForm'), commentInput: document.getElementById('commentInput'), closeComments: document.getElementById('closeComments'),
    bookGrid: document.getElementById('bookGrid'),
    autoplayToggle: document.getElementById('autoplayToggle'), muteDefaultToggle: document.getElementById('muteDefaultToggle'),
    currentGenres: document.getElementById('currentGenres'),
    btnSettings: document.getElementById('btnSettings'), changeGenresBtn: document.getElementById('changeGenresBtn'),
    ctaWatch: document.getElementById('ctaWatch'), ctaTitle: document.getElementById('ctaTitle')
  };

  function save(key){
    if(key==='likes') localStorage.setItem('likes', JSON.stringify(state.likes));
    if(key==='bookmarks') localStorage.setItem('bookmarks', JSON.stringify(state.bookmarks));
    if(key==='comments') localStorage.setItem('comments', JSON.stringify(state.comments));
    if(key==='genres') localStorage.setItem('genres', JSON.stringify(state.genres));
    if(key==='settings') localStorage.setItem('settings', JSON.stringify(state.settings));
  }

  // -------- Helpers ---------
  function toast(msg){
    els.toast.textContent = msg; els.toast.classList.add('show');
    clearTimeout(els.toast._t); els.toast._t = setTimeout(()=>els.toast.classList.remove('show'), 1600);
  }
  function mmss(t){ t=Math.max(0,Math.floor(t||0)); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; }

  function syncCtaById(id){
    const clip = CLIPS.find(c=>c.id===id); if(!clip) return;
    state.currentClipId = id;
    els.ctaWatch.dataset.url = clip.watchUrl;
    els.ctaTitle.textContent = `Смотреть: ${clip.filmTitle}`;
  }

  // -------- Build Feed ---------
  function buildFeed(){
    els.feedView.innerHTML = '';
    const list = CLIPS.filter(c=> state.genres.length? c.genres.some(g=>state.genres.includes(g)) : true);
    list.forEach((clip)=>{
      const el = document.createElement('section');
      el.className = 'clip'; el.dataset.clipId = clip.id;
      el.innerHTML = `
        <video preload="metadata" ${state.settings.autoplay? 'autoplay': ''} ${state.settings.muteDefault? 'muted': ''} playsinline webkit-playsinline src="${clip.src}" poster="${clip.poster}"></video>
        <div class="grad-top"></div><div class="grad-bottom"></div>
        <div class="play-overlay" data-act="toggle"><svg class="ic"><use href="#i-play"/></svg></div>
        <div class="info">
          <div class="title">${clip.filmTitle}</div>
          <div class="meta">${clip.year} • ${clip.genres.map(g=> (GENRES.find(x=>x.id===g)||{}).name||g).join(' • ')}</div>
          <div class="logline">${clip.logline}</div>
          <div class="tags">${(clip.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
        </div>
        <div class="actions-rail">
          <div class="action" data-act="like" title="Нравится"><svg class="ic"><use href="#i-heart"/></svg><div class="count">${state.likes[clip.id]?1:0}</div></div>
          <div class="action" data-act="bookmark" title="В закладки"><svg class="ic"><use href="#i-bookmark"/></svg><div class="count">${state.bookmarks[clip.id]?1:0}</div></div>
          <div class="action" data-act="comments" title="Комментарии"><svg class="ic"><use href="#i-chat"/></svg><div class="count">${(state.comments[clip.id]||[]).length}</div></div>
          <div class="action" data-act="share" title="Поделиться"><svg class="ic"><use href="#i-share"/></svg></div>
        </div>
      `;
      els.feedView.appendChild(el);
    });
    attachFeedHandlers();
    setupObserver();
    if(list[0]) syncCtaById(list[0].id);
  }

  // -------- Observer (autoplay & CTA sync) ---------
  let observer;
  function setupObserver(){
    observer && observer.disconnect();
    observer = new IntersectionObserver((entries)=>{
      entries.forEach(en=>{
        const vid = en.target.querySelector('video'); if(!vid) return;
        if(en.isIntersecting && en.intersectionRatio > 0.6){
          syncCtaById(en.target.dataset.clipId);
          if(state.settings.autoplay){ vid.play().catch(()=>{}); }
          const next = en.target.nextElementSibling?.querySelector('video'); if(next){ next.preload = 'auto'; }
        } else { vid.pause(); }
      })
    }, {threshold:[0,.6,1]});
    document.querySelectorAll('.clip').forEach(c=> observer.observe(c));
  }

  // -------- Handlers ---------
  function attachFeedHandlers(){
    els.feedView.addEventListener('click',(e)=>{
      const clipEl = e.target.closest('.clip'); if(!clipEl) return;
      const clip = CLIPS.find(c=> c.id === clipEl.dataset.clipId);
      const actEl = e.target.closest('[data-act]');
      if(!actEl){ return; }
      const act = actEl.dataset.act;
      if(act==='toggle'){
        const vid = clipEl.querySelector('video'); if(!vid) return; if(vid.paused) vid.play(); else vid.pause();
      }
      if(act==='like'){
        state.likes[clip.id] = !state.likes[clip.id]; save('likes');
        clipEl.querySelector('[data-act="like"] .count').textContent = state.likes[clip.id]?1:0;
        toast(state.likes[clip.id] ? 'Нравится' : 'Убрано из «Нравится»');
      }
      if(act==='bookmark'){
        state.bookmarks[clip.id] = state.bookmarks[clip.id] ? undefined : { clipId:clip.id, filmTitle:clip.filmTitle, poster:clip.poster, slug:clip.filmSlug, watchUrl:clip.watchUrl };
        if(state.bookmarks[clip.id]===undefined) delete state.bookmarks[clip.id]; save('bookmarks');
        clipEl.querySelector('[data-act="bookmark"] .count').textContent = state.bookmarks[clip.id]?1:0;
        buildBookmarks(); toast(state.bookmarks[clip.id] ? 'Добавлено в закладки' : 'Удалено из закладок');
      }
      if(act==='comments'){ openComments(clip); }
      if(act==='share'){
        const url = `${location.origin}/film/${clip.filmSlug}?clip=${clip.id}`;
        if(navigator.share){ navigator.share({title:clip.filmTitle, url}).catch(()=>{}); } else { navigator.clipboard.writeText(url); toast('Ссылка скопирована'); }
      }
    });

    // Keyboard shortcuts
    window.addEventListener('keydown',(e)=>{
      const cur = document.querySelector(`.clip[data-clip-id="${state.currentClipId}"]`); if(!cur) return;
      const vid = cur.querySelector('video');
      if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
      if(e.key==='k'){ e.preventDefault(); if(vid.paused) vid.play(); else vid.pause(); }
      if(e.key==='m'){ e.preventDefault(); vid.muted = !vid.muted; toast(vid.muted? 'Звук выключен':'Звук включен'); }
      if(e.key==='ArrowDown'){ e.preventDefault(); cur.nextElementSibling?.scrollIntoView({behavior:'smooth'}); }
      if(e.key==='ArrowUp'){ e.preventDefault(); cur.previousElementSibling?.scrollIntoView({behavior:'smooth'}); }
      if(e.key==='b'){ e.preventDefault(); cur.querySelector('[data-act="bookmark"]').click(); }
      if(e.key==='Enter'){ e.preventDefault(); els.ctaWatch.click(); }
    });

    // CTA click
    els.ctaWatch.addEventListener('click',()=>{
      const url = els.ctaWatch.dataset.url; if(url) window.open(url,'_blank','noopener');
    });
  }

  // -------- Comments ---------
  function openComments(clip){
    els.commentsList.innerHTML = '';
    els.commentsSheet.classList.add('active'); els.commentsSheet.setAttribute('aria-hidden','false');
    els.commentForm.dataset.clipId = clip.id; els.commentInput.value='';
    const list = state.comments[clip.id] || [];
    renderComments(list);
  }
  function renderComments(list){
    els.commentsList.innerHTML = list.map(it=>`
      <div class="cmt">
        <div class="ava">${(it.user||'Г').slice(0,1)}</div>
        <div class="cbody">
          <div><strong>${it.user||'Гость'}</strong> <span class="ctime">• ${new Date(it.ts).toLocaleString()} <span class="jump" data-jump="${it.time||0}">${mmss(it.time||0)}</span></span></div>
          <div>${it.text}</div>
        </div>
      </div>
    `).join('');
  }
  els.commentForm.addEventListener('submit',(e)=>{
    e.preventDefault();
    const clipId = e.currentTarget.dataset.clipId; if(!clipId) return;
    const text = els.commentInput.value.trim(); if(!text) return;
    const cur = document.querySelector(`.clip[data-clip-id="${clipId}"]`);
    const time = cur?.querySelector('video')?.currentTime || 0;
    const item = { text, time:Math.floor(time), ts: Date.now(), user:'Гость' };
    const list = state.comments[clipId] || []; list.unshift(item); state.comments[clipId]=list; save('comments');
    els.commentInput.value=''; renderComments(list);
    // update counter safely
    const cntEl = cur && cur.querySelector('[data-act="comments"] .count');
    if (cntEl) { cntEl.textContent = String(list.length); }
  });
  els.commentsList.addEventListener('click',(e)=>{
    const jump = e.target.closest('[data-jump]'); if(!jump) return;
    const t = Number(jump.dataset.jump)||0;
    const clipId = els.commentForm.dataset.clipId;
    const cur = document.querySelector(`.clip[data-clip-id="${clipId}"]`);
    const vid = cur?.querySelector('video'); if(vid){ vid.currentTime=t; vid.play().catch(()=>{}); }
  });
  els.closeComments.addEventListener('click',()=>{ els.commentsSheet.classList.remove('active'); els.commentsSheet.setAttribute('aria-hidden','true'); });

  // -------- Bookmarks ---------
  function buildBookmarks(){
    const entries = Object.values(state.bookmarks||{});
    els.bookGrid.innerHTML = entries.length? entries.map(b=>`
      <div style="background:rgba(255,255,255,.04);backdrop-filter:blur(10px);border:1px solid var(--line);border-radius:12px;overflow:hidden">
        <img alt="${b.filmTitle}" src="https://picsum.photos/seed/${b.clipId}/400/600" style="width:100%;aspect-ratio:2/3;object-fit:cover"/>
        <div style="padding:10px">
          <div style="font-weight:700">${b.filmTitle}</div>
          <div class="muted" style="font-size:13px;margin-top:4px">Сохранено</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn primary" data-open="${b.watchUrl}">Смотреть</button>
            <button class="btn" data-remove="${b.clipId}">Удалить</button>
          </div>
        </div>
      </div>
    `).join('') : `<div class="muted" style="padding:16px">В закладках пусто. Добавляйте клипы — вернётесь к ним позже.</div>`;
  }
  els.bookGrid.addEventListener('click',(e)=>{
    const open = e.target.closest('[data-open]'); if(open){ window.open(open.dataset.open,'_blank','noopener'); }
    const rm = e.target.closest('[data-remove]'); if(rm){ delete state.bookmarks[rm.dataset.remove]; save('bookmarks'); buildBookmarks(); toast('Удалено из закладок'); }
  });

  // -------- Genres Onboarding ---------
  function buildGenres(){
    els.genreChips.innerHTML = GENRES.map(g=>`<div class="chip ${state.genres.includes(g.id)?'active':''}" data-id="${g.id}">${g.name}</div>`).join('');
    els.genreChips.onclick = (e)=>{
      const chip = e.target.closest('.chip'); if(!chip) return; const id = chip.dataset.id;
      if(state.genres.includes(id)) state.genres = state.genres.filter(x=>x!==id); else state.genres.push(id);
      save('genres'); chip.classList.toggle('active');
    };
  }
  els.skipOnb.addEventListener('click',()=>els.onb.classList.remove('active'));
  els.confirmOnb.addEventListener('click',()=>{ els.onb.classList.remove('active'); buildFeed(); renderCurrentGenres(); toast('Готово! Лента обновлена.'); });

  // -------- Sidebar Nav ---------
  els.sidebarNav.addEventListener('click',(e)=>{
    const item = e.target.closest('.sitem'); if(!item) return;
    document.querySelectorAll('.sitem').forEach(i=>i.classList.toggle('active', i===item));
    const id = item.dataset.tab;
    if(id==='genres'){ buildGenres(); els.onb.classList.add('active'); return; }
    if(id==='catalog'){ window.open(item.dataset.open||CATALOG_URL,'_blank','noopener'); return; }
    showView(id);
  });
  function showView(id){
    els.bookView.classList.remove('active'); els.profileView.classList.remove('active');
    if(id==='feed'){ /* остаёмся на ленте */ }
    if(id==='bookmarks'){ els.bookView.classList.add('active'); buildBookmarks(); window.scrollTo(0,0); }
    if(id==='profile'){ els.profileView.classList.add('active'); window.scrollTo(0,0); }
  }

  // -------- Settings shortcuts ---------
  els.autoplayToggle.addEventListener('change',(e)=>{ state.settings.autoplay=e.target.checked; save('settings'); toast('Настройка сохранена'); });
  els.muteDefaultToggle.addEventListener('change',(e)=>{ state.settings.muteDefault=e.target.checked; save('settings'); buildFeed(); toast('Настройка сохранена'); });
  els.btnSettings.addEventListener('click',()=>{ buildGenres(); els.onb.classList.add('active'); });
  els.changeGenresBtn.addEventListener('click',()=>{ buildGenres(); els.onb.classList.add('active'); });

  function renderCurrentGenres(){ els.currentGenres.textContent = (state.genres||[]).length ? GENRES.filter(g=>state.genres.includes(g.id)).map(g=>g.name).join(', ') : 'Не выбрано'; }

  // -------- Init ---------
  function init(){
    if(!state.genres || !state.genres.length){ buildGenres(); els.onb.classList.add('active'); } else { buildGenres(); }
    buildFeed(); buildBookmarks(); renderCurrentGenres();
  }
  init();

  // -------- Tests ---------
  console.assert(document.querySelectorAll('.snav .sitem').length>=5,'Sidebar should have 5+ items (Клипы, Жанры, Закладки, Каталог, Профиль)');
  console.assert(document.getElementById('ctaWatch'),'CTA watch button should exist');
  console.assert(!document.querySelector('.pager'),'Pager should be removed');
  </script>
</body>
</html>
